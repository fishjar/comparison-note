<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>语言交互接口</title><link rel="preload" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" data-n-g=""/><link rel="preload" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" as="script"/></head><body><div id="__next"><nav class="navbar navbar-expand-lg navbar-light bg-light"><a href="/comparison-note/" class="navbar-brand">对比学习笔记</a><button aria-controls="basic-navbar-nav" type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="navbar-collapse collapse" id="basic-navbar-nav"><div class="mr-auto navbar-nav"><a href="/comparison-note/algorithm" data-rb-event-key="/algorithm" class="nav-link">数据结构和算法</a><a href="/comparison-note/basic-concept" data-rb-event-key="/basic-concept" class="nav-link">基础概念</a><a href="/comparison-note/data-type" data-rb-event-key="/data-type" class="nav-link">数据类型</a><a href="/comparison-note/special" data-rb-event-key="/special" class="nav-link">专题</a></div></div></nav><div style="padding-top:12px;padding-bottom:12px" class="container-fluid"><h1>语言交互接口</h1><div style="margin-bottom:12px"><div class="markdown-body"></div></div><div style="margin-bottom:12px" class="justify-content-md-center row"><div class="col-md-auto"><div role="toolbar" class="btn-toolbar"><div role="group" class="btn-group btn-group-sm btn-group-toggle"><label class="btn btn-secondary"><input type="checkbox" value="go" autoComplete="off"/>go</label></div></div></div></div><div class="card-group"></div></div><div style="text-align:center;padding:12px 0;font-size:14px">v<!-- -->0.1.0<!-- --> <a href="https://github.com/fishjar/comparison-note" title="访问github源码">github</a></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"nav":{"name":"ffi","fullPath":"/special/ffi","asPath":"/special/ffi","id":"%2Fspecial%2Fffi","parent":{"name":"special","fullPath":"/special","asPath":"/special","id":"%2Fspecial","readme":{"title":"专题","fullPath":"/special/README.md"}},"readme":{"title":"语言交互接口","fullPath":"/special/ffi/README.md"},"cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/ffi/go.md"}],"nodes":[]},"content":"","cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/ffi/go.md","content":"## CGO 基础\n\n要使用 CGO 特性，需要安装 C/C++ 构建工具链，\n在 macOS 和 Linux 下是要安装 GCC，\n在 windows 下是需要安装 MinGW 工具。\n\n同时需要保证环境变量 `CGO_ENABLED` 被设置为 1，这表示 CGO 是被启用的状态。\n在本地构建时 `CGO_ENABLED` 默认是启用的，当交叉构建时 CGO 默认是禁止的。\n\n比如要交叉构建 ARM 环境运行的 Go 程序，\n需要手工设置好 C/C++ 交叉构建的工具链，\n同时开启 `CGO_ENABLED` 环境变量。\n然后通过 `import \"C\"` 语句启用 CGO 特性。\n\n## CGO 示例\n\n基于 C 标准库函数输出字符串\n\n```go\n// hello.go\npackage main\n\n//#include \u003cstdio.h\u003e\nimport \"C\"\n\nfunc main() {\n    C.puts(C.CString(\"Hello, World\\n\"))\n}\n```\n\n使用自己的 C 函数\n\n```go\n// hello.go\npackage main\n\n/*\n#include \u003cstdio.h\u003e\n\nstatic void SayHello(const char* s) {\n    puts(s);\n}\n*/\nimport \"C\"\n\nfunc main() {\n    C.SayHello(C.CString(\"Hello, World\\n\"))\n}\n```\n\n将 `SayHello` 函数放到当前目录下的一个 `C` 语言源文件中（后缀名必须是 `.c`）\n\n注意，如果之前运行的命令是 `go run hello.go` 或 `go build hello.go` 的话，\n此处须使用 `go run \"your/package\"` 或 `go build \"your/package\"` 才可以。\n若本就在包路径下的话，也可以直接运行 `go run .` 或 `go build`\n\n```c++\n// hello.c\n\n#include \u003cstdio.h\u003e\n\nvoid SayHello(const char* s) {\n    puts(s);\n}\n```\n\n```go\n// hello.go\npackage main\n\n//void SayHello(const char* s);\nimport \"C\"\n\nfunc main() {\n    C.SayHello(C.CString(\"Hello, World\\n\"))\n}\n```\n\n## C 代码的模块化\n\n```c++\n// hello.h\nvoid SayHello(const char* s);\n```\n\n```c++\n// hello.c\n\n#include \"hello.h\"\n#include \u003cstdio.h\u003e\n\nvoid SayHello(const char* s) {\n    puts(s);\n}\n```\n\n## 用 Go 重新实现 C 函数\n\n```c++\n// hello.h\nvoid SayHello(/*const*/ char* s);\n```\n\n通过 `CGO` 的 `//export SayHello` 指令将 Go 语言实现的函数 `SayHello` 导出为 C 语言函数。\n\n```go\n// hello.go\npackage main\n\nimport \"C\"\n\nimport \"fmt\"\n\n//export SayHello\nfunc SayHello(s *C.char) {\n    fmt.Print(C.GoString(s))\n}\n```\n\n## 面向 C 接口的 Go 编程\n\n几个文件重新合并到一个 Go 文件\n\n```go\npackage main\n\n//void SayHello(char* s);\nimport \"C\"\n\nimport (\n    \"fmt\"\n)\n\nfunc main() {\n    C.SayHello(C.CString(\"Hello, World\\n\"))\n}\n\n//export SayHello\nfunc SayHello(s *C.char) {\n    fmt.Print(C.GoString(s))\n}\n```\n\nGo1.10 中 CGO 新增加了一个 `_GoString_` 预定义的 C 语言类型，用来表示 Go 语言字符串\n\n```go\n// +build go1.10\n\npackage main\n\n//void SayHello(_GoString_ s);\nimport \"C\"\n\nimport (\n    \"fmt\"\n)\n\nfunc main() {\n    C.SayHello(\"Hello, World\\n\")\n}\n\n//export SayHello\nfunc SayHello(s string) {\n    fmt.Print(s)\n}\n```\n\n虽然看起来全部是 Go 语言代码，\n但是执行的时候是先从 Go 语言的 `main` 函数，\n到 CGO 自动生成的 C 语言版本 `SayHello` 桥接函数，\n最后又回到了 Go 语言环境的 `SayHello` 函数。\n\n## `#cgo` 语句\n\n在 `import \"C\"` 语句前的注释中可以通过 `#cgo` 语句设置编译阶段和链接阶段的相关参数。\n\n```go\n// #cgo CFLAGS: -DPNG_DEBUG=1 -I./include\n// #cgo LDFLAGS: -L/usr/local/lib -lpng\n// #include \u003cpng.h\u003e\nimport \"C\"\n```\n\nCFLAGS 部分，\n`-D` 部分定义了宏 PNG_DEBUG，值为 1；\n`-I` 定义了头文件包含的检索目录。\n\nLDFLAGS 部分，\n`-L` 指定了链接时库文件检索目录，\n`-l` 指定了链接时需要链接 png 库。\n\n因为 C/C++ 遗留的问题，\nC 头文件检索目录可以是相对目录，\n但是库文件检索目录则需要绝对路径。\n在库文件的检索目录中可以通过 `${SRCDIR}` 变量表示当前包目录的绝对路径：\n\n```go\n// #cgo LDFLAGS: -L${SRCDIR}/libs -lfoo\n```\n\n展开后\n\n```go\n// #cgo LDFLAGS: -L/go/src/foo/libs -lfoo\n```\n\n条件编译选项\n\n```go\n// #cgo windows CFLAGS: -DX86=1\n// #cgo !windows LDFLAGS: -lm\n```\n\n```go\npackage main\n\n/*\n#cgo windows CFLAGS: -DCGO_OS_WINDOWS=1\n#cgo darwin CFLAGS: -DCGO_OS_DARWIN=1\n#cgo linux CFLAGS: -DCGO_OS_LINUX=1\n\n#if defined(CGO_OS_WINDOWS)\n    const char* os = \"windows\";\n#elif defined(CGO_OS_DARWIN)\n    const char* os = \"darwin\";\n#elif defined(CGO_OS_LINUX)\n    const char* os = \"linux\";\n#else\n#\terror(unknown os)\n#endif\n*/\nimport \"C\"\n\nfunc main() {\n    print(C.GoString(C.os))\n}\n```\n\n## build tag 条件编译\n\n下面的源文件只有在设置 `debug` 构建标志时才会被构建\n\n```go\n// +build debug\n\npackage main\n\nvar buildMode = \"debug\"\n```\n\n```sh\ngo build -tags=\"debug\"\ngo build -tags=\"windows debug\"\n```\n\n`linux,386` 中 `linux` 和 `386` 用逗号链接表示 AND 的意思；\n而 `linux,386` 和 `darwin,!cgo` 之间通过空白分割来表示 OR 的意思。\n\n```go\n// +build linux,386 darwin,!cgo\n```\n"}]}},"page":"/[...param]","query":{"param":["special","ffi"]},"buildId":"S-jJrz2DKYE9I2Mqo2Xou","assetPrefix":"/comparison-note","nextExport":true,"isFallback":false,"gip":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"语言交互接口"}]]}</script><script nomodule="" src="/comparison-note/_next/static/chunks/polyfills-7258ef49cf482e03ae9c.js"></script><script src="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" async=""></script><script src="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" async=""></script><script src="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" async=""></script><script src="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" async=""></script><script src="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" async=""></script><script src="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_buildManifest.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_ssgManifest.js" async=""></script></body></html>
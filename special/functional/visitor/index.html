<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Visitor 模式</title><link rel="preload" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" data-n-g=""/><link rel="preload" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" as="script"/></head><body><div id="__next"><nav class="navbar navbar-expand-lg navbar-light bg-light"><a href="/comparison-note/" class="navbar-brand">对比学习笔记</a><button aria-controls="basic-navbar-nav" type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="navbar-collapse collapse" id="basic-navbar-nav"><div class="mr-auto navbar-nav"><a href="/comparison-note/algorithm" data-rb-event-key="/algorithm" class="nav-link">数据结构和算法</a><a href="/comparison-note/basic-concept" data-rb-event-key="/basic-concept" class="nav-link">基础概念</a><a href="/comparison-note/data-type" data-rb-event-key="/data-type" class="nav-link">数据类型</a><a href="/comparison-note/special" data-rb-event-key="/special" class="nav-link">专题</a></div></div></nav><div style="padding-top:12px;padding-bottom:12px" class="container-fluid"><h1>Visitor 模式</h1><div style="margin-bottom:12px"><div class="markdown-body"></div></div><div style="margin-bottom:12px" class="justify-content-md-center row"><div class="col-md-auto"><div role="toolbar" class="btn-toolbar"><div role="group" class="btn-group btn-group-sm btn-group-toggle"><label class="btn btn-secondary"><input type="checkbox" value="go" autoComplete="off"/>go</label></div></div></div></div><div class="card-group"></div></div><div style="text-align:center;padding:12px 0;font-size:14px">v<!-- -->0.1.0<!-- --> <a href="https://github.com/fishjar/comparison-note" title="访问github源码">github</a></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"nav":{"name":"visitor","fullPath":"/special/functional/visitor","asPath":"/special/functional/visitor","id":"%2Fspecial%2Ffunctional%2Fvisitor","parent":{"name":"functional","fullPath":"/special/functional","asPath":"/special/functional","id":"%2Fspecial%2Ffunctional","readme":{"title":"函数式编程","fullPath":"/special/functional/README.md"}},"readme":{"title":"Visitor 模式","fullPath":"/special/functional/visitor/README.md"},"cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/functional/visitor/go.md"}],"nodes":[]},"content":"","cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/functional/visitor/go.md","content":"## 一个简单示例\n\n```go\npackage main\n\nimport (\n\t\"encoding/json\"\n\t\"encoding/xml\"\n\t\"fmt\"\n)\n\n// 定义一个 visitor 函数，参数是一个接口类型\ntype Visitor func(shape Shape)\n\n// 接口包含一个accept方法，参数是 visitor 函数\n// Shape 方法的的参数 的参数是自己\ntype Shape interface {\n\taccept(Visitor)\n}\n\n// 定义一个结构体\ntype Circle struct {\n\tRadius int\n}\n\n// 把结构体自己当作参数，传给参数函数的参数\nfunc (c Circle) accept(v Visitor) {\n\tv(c)\n}\n\n// // 定义另一个结构体\ntype Rectangle struct {\n\tWidth, Heigh int\n}\n\nfunc (r Rectangle) accept(v Visitor) {\n\tv(r)\n}\n\n// 实现一个visitor函数\nfunc JsonVisitor(shape Shape) {\n\tbytes, err := json.Marshal(shape)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(string(bytes))\n}\n\n// 实现另一个visitor函数\nfunc XmlVisitor(shape Shape) {\n\tbytes, err := xml.Marshal(shape)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(string(bytes))\n}\n\nfunc main() {\n\tc := Circle{10}\n\tr := Rectangle{100, 200}\n\tshapes := []Shape{c, r}\n\n\tfor _, s := range shapes {\n\t\ts.accept(JsonVisitor)\n\t\ts.accept(XmlVisitor)\n\t}\n}\n```\n\n```sh\n{\"Radius\":10}\n\u003cCircle\u003e\u003cRadius\u003e10\u003c/Radius\u003e\u003c/Circle\u003e\n{\"Width\":100,\"Heigh\":200}\n\u003cRectangle\u003e\u003cWidth\u003e100\u003c/Width\u003e\u003cHeigh\u003e200\u003c/Heigh\u003e\u003c/Rectangle\u003e\n```\n\n## kubectl 的实现方法\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n)\n\n// 定义一个函数\ntype VisitorFunc func(*Info, error) error\n\n// 定义一个接口\ntype Visitor interface {\n\tVisit(VisitorFunc) error\n}\n\n// 定义一个结构体\ntype Info struct {\n\tNamespace   string\n\tName        string\n\tOtherThings string\n}\n\n// 实现接口\nfunc (info *Info) Visit(fn VisitorFunc) error {\n\tfmt.Println(\"Info Visit()\")\n\treturn fn(info, nil)\n}\n\n// 嵌入 visitor 字段\ntype NameVisitor struct {\n\tvisitor Visitor\n}\n\n// 实现接口\nfunc (v NameVisitor) Visit(fn VisitorFunc) error {\n\tfmt.Println(\"NameVisitor Visit()\")\n\t// 调用嵌入字段的同名函数\n\t// 相当于调用套娃里面的同名函数\n\treturn v.visitor.Visit(func(info *Info, err error) error {\n\t\tfmt.Println(\"NameVisitor() before call function\")\n\t\terr = fn(info, err) // 这里调用上层套娃函数\n\t\tif err == nil {\n\t\t\tfmt.Printf(\"==\u003e Name=%s, NameSpace=%s\\n\", info.Name, info.Namespace)\n\t\t}\n\t\tfmt.Println(\"NameVisitor() after call function\")\n\t\treturn err\n\t})\n}\n\ntype OtherThingsVisitor struct {\n\tvisitor Visitor\n}\n\nfunc (v OtherThingsVisitor) Visit(fn VisitorFunc) error {\n\tfmt.Println(\"OtherThingsVisitor Visit()\")\n\treturn v.visitor.Visit(func(info *Info, err error) error {\n\t\tfmt.Println(\"OtherThingsVisitor() before call function\")\n\t\terr = fn(info, err)\n\t\tif err == nil {\n\t\t\tfmt.Printf(\"==\u003e OtherThings=%s\\n\", info.OtherThings)\n\t\t}\n\t\tfmt.Println(\"OtherThingsVisitor() after call function\")\n\t\treturn err\n\t})\n}\n\ntype LogVisitor struct {\n\tvisitor Visitor\n}\n\nfunc (v LogVisitor) Visit(fn VisitorFunc) error {\n\tfmt.Println(\"LogVisitor Visit()\")\n\treturn v.visitor.Visit(func(info *Info, err error) error {\n\t\tfmt.Println(\"LogVisitor() before call function\")\n\t\terr = fn(info, err)\n\t\tfmt.Println(\"LogVisitor() after call function\")\n\t\treturn err\n\t})\n}\n\nfunc main() {\n\tinfo := Info{}\n\tvar v Visitor = \u0026info\n\t// v 结构体做了三次套娃\n\tv = LogVisitor{v}\n\tv = NameVisitor{v}\n\tv = OtherThingsVisitor{v}\n\n\tloadFile := func(info *Info, err error) error {\n\t\tfmt.Println(\"loadFile()\")\n\t\tinfo.Name = \"Hao Chen\"\n\t\tinfo.Namespace = \"MegaEase\"\n\t\tinfo.OtherThings = \"We are running as remote team.\"\n\t\treturn nil\n\t}\n\tv.Visit(loadFile)\n}\n```\n\n## visitor 修饰器\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n)\n\ntype VisitorFunc func(*Info, error) error\n\ntype Visitor interface {\n\tVisit(VisitorFunc) error\n}\n\ntype Info struct {\n\tNamespace   string\n\tName        string\n\tOtherThings string\n}\n\nfunc (info *Info) Visit(fn VisitorFunc) error {\n\tfmt.Println(\"Info Visit()\")\n\treturn fn(info, nil)\n}\n\nfunc NameVisitor(info *Info, err error) error {\n\tfmt.Println(\"NameVisitor() before call function\")\n\tfmt.Printf(\"==\u003e Name=%s, NameSpace=%s\\n\", info.Name, info.Namespace)\n\treturn err\n}\n\nfunc OtherVisitor(info *Info, err error) error {\n\tfmt.Println(\"OtherThingsVisitor() before call function\")\n\treturn err\n}\n\ntype DecoratedVisitor struct {\n\tvisitor    Visitor\n\tdecorators []VisitorFunc\n}\n\nfunc NewDecoratedVisitor(v Visitor, fn ...VisitorFunc) Visitor {\n\tif len(fn) == 0 {\n\t\treturn v\n\t}\n\treturn DecoratedVisitor{v, fn}\n}\n\nfunc (v DecoratedVisitor) Visit(fn VisitorFunc) error {\n\tfmt.Println(\"DecoratedVisitor Visit()\")\n\treturn v.visitor.Visit(func(info *Info, err error) error {\n\t\tfmt.Println(\"DecoratedVisitor v.visitor.Visit()\")\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err := fn(info, nil); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor i := range v.decorators {\n\t\t\tif err := v.decorators[i](info, nil); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n}\n\nfunc main() {\n\tinfo := Info{}\n\tvar v Visitor = \u0026info\n\tv = NewDecoratedVisitor(v, NameVisitor, OtherVisitor)\n\n\tloadFile := func(info *Info, err error) error {\n\t\tfmt.Println(\"loadFile()\")\n\t\tinfo.Name = \"Hao Chen\"\n\t\tinfo.Namespace = \"MegaEase\"\n\t\tinfo.OtherThings = \"We are running as remote team.\"\n\t\treturn nil\n\t}\n\n\tv.Visit(loadFile)\n}\n```\n"}]}},"page":"/[...param]","query":{"param":["special","functional","visitor"]},"buildId":"S-jJrz2DKYE9I2Mqo2Xou","assetPrefix":"/comparison-note","nextExport":true,"isFallback":false,"gip":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"Visitor 模式"}]]}</script><script nomodule="" src="/comparison-note/_next/static/chunks/polyfills-7258ef49cf482e03ae9c.js"></script><script src="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" async=""></script><script src="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" async=""></script><script src="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" async=""></script><script src="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" async=""></script><script src="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" async=""></script><script src="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_buildManifest.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_ssgManifest.js" async=""></script></body></html>
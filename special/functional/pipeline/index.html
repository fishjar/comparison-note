<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Pipeline 流式处理</title><link rel="preload" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" data-n-g=""/><link rel="preload" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" as="script"/></head><body><div id="__next"><nav class="navbar navbar-expand-lg navbar-light bg-light"><a href="/comparison-note/" class="navbar-brand">对比学习笔记</a><button aria-controls="basic-navbar-nav" type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="navbar-collapse collapse" id="basic-navbar-nav"><div class="mr-auto navbar-nav"><a href="/comparison-note/algorithm" data-rb-event-key="/algorithm" class="nav-link">数据结构和算法</a><a href="/comparison-note/basic-concept" data-rb-event-key="/basic-concept" class="nav-link">基础概念</a><a href="/comparison-note/data-type" data-rb-event-key="/data-type" class="nav-link">数据类型</a><a href="/comparison-note/special" data-rb-event-key="/special" class="nav-link">专题</a></div></div></nav><div style="padding-top:12px;padding-bottom:12px" class="container-fluid"><h1>Pipeline 流式处理</h1><div style="margin-bottom:12px"><div class="markdown-body"></div></div><div style="margin-bottom:12px" class="justify-content-md-center row"><div class="col-md-auto"><div role="toolbar" class="btn-toolbar"><div role="group" class="btn-group btn-group-sm btn-group-toggle"><label class="btn btn-secondary"><input type="checkbox" value="go" autoComplete="off"/>go</label></div></div></div></div><div class="card-group"></div></div><div style="text-align:center;padding:12px 0;font-size:14px">v<!-- -->0.1.0<!-- --> <a href="https://github.com/fishjar/comparison-note" title="访问github源码">github</a></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"nav":{"name":"pipeline","fullPath":"/special/functional/pipeline","asPath":"/special/functional/pipeline","id":"%2Fspecial%2Ffunctional%2Fpipeline","parent":{"name":"functional","fullPath":"/special/functional","asPath":"/special/functional","id":"%2Fspecial%2Ffunctional","readme":{"title":"函数式编程","fullPath":"/special/functional/README.md"}},"readme":{"title":"Pipeline 流式处理","fullPath":"/special/functional/pipeline/README.md"},"cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/functional/pipeline/go.md"}],"nodes":[]},"content":"","cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/functional/pipeline/go.md","content":"## Channel 管理\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n)\n\n// Channel转发函数\nfunc echo(nums []int) \u003c-chan int {\n\tout := make(chan int)\n\tgo func() {\n\t\tfor _, n := range nums {\n\t\t\tout \u003c- n\n\t\t}\n\t\tclose(out)\n\t}()\n\treturn out\n}\n\n// 平方函数\nfunc sq(in \u003c-chan int) \u003c-chan int {\n\tout := make(chan int)\n\tgo func() {\n\t\tfor n := range in {\n\t\t\tout \u003c- n * n\n\t\t}\n\t\tclose(out)\n\t}()\n\treturn out\n}\n\n// 过滤奇数函数\nfunc odd(in \u003c-chan int) \u003c-chan int {\n\tout := make(chan int)\n\tgo func() {\n\t\tfor n := range in {\n\t\t\tif n%2 != 0 {\n\t\t\t\tout \u003c- n\n\t\t\t}\n\t\t}\n\t\tclose(out)\n\t}()\n\treturn out\n}\n\n// 求和函数\nfunc sum(in \u003c-chan int) \u003c-chan int {\n\tout := make(chan int)\n\tgo func() {\n\t\tvar sum = 0\n\t\tfor n := range in {\n\t\t\tsum += n\n\t\t}\n\t\tout \u003c- sum\n\t\tclose(out)\n\t}()\n\treturn out\n}\n\nfunc main() {\n\tvar nums = []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 10}\n\tfor n := range sum(sq(odd(echo(nums)))) {\n\t\tfmt.Println(n)\n\t}\n}\n```\n\n使用一个代理函数来完成\n\n```go\n// ...\n\ntype EchoFunc func([]int) \u003c-chan int\ntype PipeFunc func(\u003c-chan int) \u003c-chan int\n\nfunc pipeline(nums []int, echo EchoFunc, pipeFns ...PipeFunc) \u003c-chan int {\n\tch := echo(nums)\n\tfor i := range pipeFns {\n\t\tch = pipeFns[i](ch)\n\t}\n\treturn ch\n}\n\nfunc main() {\n\tvar nums = []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 10}\n\tfor n := range pipeline(nums, echo, odd, sq, sum) {\n\t\tfmt.Println(n)\n\t}\n}\n```\n\n## Fan in/Out\n\n通过并发的方式来对一个很长的数组中的质数进行求和运算，\n我们想先把数组分段求和，然后再把其集中起来。\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"math\"\n\t\"sync\"\n)\n\nfunc echo(nums []int) \u003c-chan int {\n\tout := make(chan int)\n\tgo func() {\n\t\tfor _, n := range nums {\n\t\t\tout \u003c- n\n\t\t}\n\t\tclose(out)\n\t}()\n\treturn out\n}\n\nfunc sum(in \u003c-chan int) \u003c-chan int {\n\tout := make(chan int)\n\tgo func() {\n\t\tvar sum = 0\n\t\tfor n := range in {\n\t\t\tsum += n\n\t\t}\n\t\tout \u003c- sum\n\t\tclose(out)\n\t}()\n\treturn out\n}\n\nfunc is_prime(value int) bool {\n    // 非素书，约数最小是2,另一个约数最大是value/2\n    // 因此迭代验证到value/2即可\n\tfor i := 2; i \u003c= int(math.Floor(float64(value)/2)); i++ {\n\t\tif value%i == 0 {\n\t\t\treturn false\n\t\t}\n\t}\n\treturn value \u003e 1\n}\n\nfunc prime(in \u003c-chan int) \u003c-chan int {\n\tout := make(chan int)\n\tgo func() {\n\t\tfor n := range in {\n\t\t\tif is_prime(n) {\n\t\t\t\tout \u003c- n\n\t\t\t}\n\t\t}\n\t\tclose(out)\n\t}()\n\treturn out\n}\n\nfunc makeRange(min, max int) []int {\n\ta := make([]int, max-min+1)\n\tfor i := range a {\n\t\ta[i] = min + i\n\t}\n\treturn a\n}\n\n// cs 是 sum 里面定义的 channel 列表\nfunc merge(cs []\u003c-chan int) \u003c-chan int {\n\tvar wg sync.WaitGroup\n\tout := make(chan int)\n\n\twg.Add(len(cs))\n\tfor _, c := range cs {\n\t\tgo func(c \u003c-chan int) {\n\t\t\tfor n := range c {\n\t\t\t\tout \u003c- n\n\t\t\t}\n\t\t\twg.Done()\n\t\t}(c)\n\t}\n\tgo func() {\n\t\twg.Wait()\n\t\tclose(out)\n\t}()\n\treturn out\n}\n\nfunc main() {\n\tnums := makeRange(1, 10000) // 生成1-10000的数组\n\tin := echo(nums)            // 将数组放到一个go程的channel\n\n\tconst nProcess = 5             // 并发数量\n\tvar chans [nProcess]\u003c-chan int // 初始化5个channel\n\tfor i := range chans {\n\t\t// 从 in 取数据，并连续执行 Pipeline 函数（prime过滤，sum求和），并将结果放进 channel\n\t\t// 返回的 channel 是 sum 里面定义的\n\t\tchans[i] = sum(prime(in))\n\t}\n\n\t// merge 其实和 echo 函数类似的做用\n\t// echo 是将列表的数据放到一个 channel\n\t// merge 是将不同的 channel 的数据 合并到一个 channel\n\t// 然后就可以再次调用 sum 函数\n\tfor n := range sum(merge(chans[:])) {\n\t\tfmt.Println(n)\n\t}\n}\n```\n"}]}},"page":"/[...param]","query":{"param":["special","functional","pipeline"]},"buildId":"S-jJrz2DKYE9I2Mqo2Xou","assetPrefix":"/comparison-note","nextExport":true,"isFallback":false,"gip":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"Pipeline 流式处理"}]]}</script><script nomodule="" src="/comparison-note/_next/static/chunks/polyfills-7258ef49cf482e03ae9c.js"></script><script src="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" async=""></script><script src="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" async=""></script><script src="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" async=""></script><script src="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" async=""></script><script src="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" async=""></script><script src="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_buildManifest.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_ssgManifest.js" async=""></script></body></html>
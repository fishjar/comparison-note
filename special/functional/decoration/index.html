<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Decoraton 修饰器（装饰器）</title><link rel="preload" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" data-n-g=""/><link rel="preload" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" as="script"/></head><body><div id="__next"><nav class="navbar navbar-expand-lg navbar-light bg-light"><a href="/comparison-note/" class="navbar-brand">对比学习笔记</a><button aria-controls="basic-navbar-nav" type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="navbar-collapse collapse" id="basic-navbar-nav"><div class="mr-auto navbar-nav"><a href="/comparison-note/algorithm" data-rb-event-key="/algorithm" class="nav-link">数据结构和算法</a><a href="/comparison-note/basic-concept" data-rb-event-key="/basic-concept" class="nav-link">基础概念</a><a href="/comparison-note/data-type" data-rb-event-key="/data-type" class="nav-link">数据类型</a><a href="/comparison-note/special" data-rb-event-key="/special" class="nav-link">专题</a></div></div></nav><div style="padding-top:12px;padding-bottom:12px" class="container-fluid"><h1>Decoraton 修饰器（装饰器）</h1><div style="margin-bottom:12px"><div class="markdown-body"></div></div><div style="margin-bottom:12px" class="justify-content-md-center row"><div class="col-md-auto"><div role="toolbar" class="btn-toolbar"><div role="group" class="btn-group btn-group-sm btn-group-toggle"><label class="btn btn-secondary"><input type="checkbox" value="go" autoComplete="off"/>go</label></div></div></div></div><div class="card-group"></div></div><div style="text-align:center;padding:12px 0;font-size:14px">v<!-- -->0.1.0<!-- --> <a href="https://github.com/fishjar/comparison-note" title="访问github源码">github</a></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"nav":{"name":"decoration","fullPath":"/special/functional/decoration","asPath":"/special/functional/decoration","id":"%2Fspecial%2Ffunctional%2Fdecoration","parent":{"name":"functional","fullPath":"/special/functional","asPath":"/special/functional","id":"%2Fspecial%2Ffunctional","readme":{"title":"函数式编程","fullPath":"/special/functional/README.md"}},"readme":{"title":"Decoraton 修饰器（装饰器）","fullPath":"/special/functional/decoration/README.md"},"cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/functional/decoration/go.md"}],"nodes":[]},"content":"","cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/functional/decoration/go.md","content":"## 简单示例\n\n```go\npackage main\n\nimport \"fmt\"\n\n// 函数的入参和出参都是一个函数\nfunc decorator(f func(s string)) func(s string) {\n    return func(s string) {\n        fmt.Println(\"Started\")\n        f(s)\n        fmt.Println(\"Done\")\n    }\n}\n\nfunc Hello(s string) {\n    fmt.Println(s)\n}\n\nfunc main() {\n    // decorator(Hello)(\"Hello, World!\")\n    hello := decorator(Hello)\n    hello(\"Hello\")\n}\n```\n\n## 计算运行时间的例子\n\n```go\npackage main\n\nimport (\n  \"fmt\"\n  \"reflect\"\n  \"runtime\"\n  \"time\"\n)\n\n// 定义入参出参函数\ntype SumFunc func(int64, int64) int64\n\n// 利用反射获取函数名称\nfunc getFunctionName(i interface{}) string {\n  return runtime.FuncForPC(reflect.ValueOf(i).Pointer()).Name()\n}\n\n// 修饰器函数，入参出参都是一个函数\nfunc timedSumFunc(f SumFunc) SumFunc {\n  return func(start, end int64) int64 {\n\n    // defer函数的入参计算好后，等待后面执行完才执行defer内部\n    defer func(t time.Time) {\n      fmt.Printf(\"--- Time Elapsed (%s): %v ---\\n\",\n          getFunctionName(f), time.Since(t))\n    }(time.Now())\n\n    return f(start, end)\n  }\n}\n\n// 耗时计算1,里面细节不重要\nfunc Sum1(start, end int64) int64 {\n  var sum int64\n  sum = 0\n  if start \u003e end {\n    start, end = end, start\n  }\n  for i := start; i \u003c= end; i++ {\n    sum += i\n  }\n  return sum\n}\n\n// 耗时计算2,里面细节不重要\nfunc Sum2(start, end int64) int64 {\n  if start \u003e end {\n    start, end = end, start\n  }\n  return (end - start + 1) * (end + start) / 2\n}\n\nfunc main() {\n  sum1 := timedSumFunc(Sum1)\n  sum2 := timedSumFunc(Sum2)\n  fmt.Printf(\"%d, %d\\n\", sum1(-10000, 10000000), sum2(-10000, 10000000))\n}\n```\n\n```sh\n$ go run time.sum.go\n--- Time Elapsed (main.Sum1): 3.557469ms ---\n--- Time Elapsed (main.Sum2): 291ns ---\n49999954995000, 49999954995000\n```\n\n## HTTP 相关的一个示例\n\n修饰函数可以套娃，多层嵌套\n\n```go\npackage main\n\nimport (\n    \"fmt\"\n    \"log\"\n    \"net/http\"\n    \"strings\"\n)\n\nfunc WithServerHeader(h http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        log.Println(\"---\u003eWithServerHeader()\")\n        w.Header().Set(\"Server\", \"HelloServer v0.0.1\")\n        h(w, r)\n    }\n}\n\nfunc WithAuthCookie(h http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        log.Println(\"---\u003eWithAuthCookie()\")\n        cookie := \u0026http.Cookie{Name: \"Auth\", Value: \"Pass\", Path: \"/\"}\n        http.SetCookie(w, cookie)\n        h(w, r)\n    }\n}\n\nfunc WithBasicAuth(h http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        log.Println(\"---\u003eWithBasicAuth()\")\n        cookie, err := r.Cookie(\"Auth\")\n        if err != nil || cookie.Value != \"Pass\" {\n            w.WriteHeader(http.StatusForbidden)\n            return\n        }\n        h(w, r)\n    }\n}\n\nfunc WithDebugLog(h http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        log.Println(\"---\u003eWithDebugLog\")\n        r.ParseForm()\n        log.Println(r.Form)\n        log.Println(\"path\", r.URL.Path)\n        log.Println(\"scheme\", r.URL.Scheme)\n        log.Println(r.Form[\"url_long\"])\n        for k, v := range r.Form {\n            log.Println(\"key:\", k)\n            log.Println(\"val:\", strings.Join(v, \"\"))\n        }\n        h(w, r)\n    }\n}\n\n// 这个函数是修饰函数的参数，也是最里层实际执行的函数\n// 定义和http.HandlerFunc是一样的\nfunc hello(w http.ResponseWriter, r *http.Request) {\n    log.Printf(\"Recieved Request %s from %s\\n\", r.URL.Path, r.RemoteAddr)\n    fmt.Fprintf(w, \"Hello, World! \"+r.URL.Path)\n}\n\nfunc main() {\n    http.HandleFunc(\"/v1/hello\", WithServerHeader(WithAuthCookie(hello)))\n    http.HandleFunc(\"/v2/hello\", WithServerHeader(WithBasicAuth(hello)))\n    http.HandleFunc(\"/v3/hello\", WithServerHeader(WithBasicAuth(WithDebugLog(hello))))\n    err := http.ListenAndServe(\":8080\", nil)\n    if err != nil {\n        log.Fatal(\"ListenAndServe: \", err)\n    }\n}\n```\n\n## 多个修饰器的 Pipeline\n\n```go\n// 修饰函数的定义\ntype HttpHandlerDecorator func(http.HandlerFunc) http.HandlerFunc\n\nfunc Handler(h http.HandlerFunc, decors ...HttpHandlerDecorator) http.HandlerFunc {\n    for i := range decors {\n        // 逆序执行修饰器函数\n        d := decors[len(decors)-1-i] // iterate in reverse\n        h = d(h)\n    }\n    return h\n}\n\nhttp.HandleFunc(\"/v4/hello\", Handler(hello,\n    WithServerHeader, WithBasicAuth, WithDebugLog))\n```\n\n## 泛型的修饰器\n\n```go\nfunc Decorator(decoPtr, fn interface{}) (err error) {\n    var decoratedFunc, targetFunc reflect.Value\n\n    decoratedFunc = reflect.ValueOf(decoPtr).Elem()\n    targetFunc = reflect.ValueOf(fn)\n\n    v := reflect.MakeFunc(targetFunc.Type(),\n            func(in []reflect.Value) (out []reflect.Value) {\n                fmt.Println(\"before\")\n                out = targetFunc.Call(in)\n                fmt.Println(\"after\")\n                return\n            })\n\n    decoratedFunc.Set(v)\n    return\n}\nfunc foo(a, b, c int) int {\n    fmt.Printf(\"%d, %d, %d \\n\", a, b, c)\n    return a + b + c\n}\nfunc bar(a, b string) string {\n    fmt.Printf(\"%s, %s \\n\", a, b)\n    return a + b\n}\n\ntype MyFoo func(int, int, int) int\nvar myfoo MyFoo\nDecorator(\u0026myfoo, foo)\nmyfoo(1, 2, 3)\n\n// or\nmybar := bar\nDecorator(\u0026mybar, bar)\nmybar(\"hello,\", \"world!\")\n```\n"}]}},"page":"/[...param]","query":{"param":["special","functional","decoration"]},"buildId":"S-jJrz2DKYE9I2Mqo2Xou","assetPrefix":"/comparison-note","nextExport":true,"isFallback":false,"gip":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"Decoraton 修饰器（装饰器）"}]]}</script><script nomodule="" src="/comparison-note/_next/static/chunks/polyfills-7258ef49cf482e03ae9c.js"></script><script src="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" async=""></script><script src="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" async=""></script><script src="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" async=""></script><script src="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" async=""></script><script src="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" async=""></script><script src="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_buildManifest.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_ssgManifest.js" async=""></script></body></html>
<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>WebAssembly</title><link rel="preload" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" data-n-g=""/><link rel="preload" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" as="script"/></head><body><div id="__next"><nav class="navbar navbar-expand-lg navbar-light bg-light"><a href="/comparison-note/" class="navbar-brand">对比学习笔记</a><button aria-controls="basic-navbar-nav" type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="navbar-collapse collapse" id="basic-navbar-nav"><div class="mr-auto navbar-nav"><a href="/comparison-note/algorithm" data-rb-event-key="/algorithm" class="nav-link">数据结构和算法</a><a href="/comparison-note/basic-concept" data-rb-event-key="/basic-concept" class="nav-link">基础概念</a><a href="/comparison-note/data-type" data-rb-event-key="/data-type" class="nav-link">数据类型</a><a href="/comparison-note/special" data-rb-event-key="/special" class="nav-link">专题</a></div></div></nav><div style="padding-top:12px;padding-bottom:12px" class="container-fluid"><h1>WebAssembly</h1><div style="margin-bottom:12px"><div class="markdown-body"></div></div><div style="margin-bottom:12px" class="justify-content-md-center row"><div class="col-md-auto"><div role="toolbar" class="btn-toolbar"><div role="group" class="btn-group btn-group-sm btn-group-toggle"><label class="btn btn-secondary"><input type="checkbox" value="go" autoComplete="off"/>go</label><label class="btn btn-secondary"><input type="checkbox" value="rust" autoComplete="off"/>rust</label></div></div></div></div><div class="card-group"></div></div><div style="text-align:center;padding:12px 0;font-size:14px">v<!-- -->0.1.0<!-- --> <a href="https://github.com/fishjar/comparison-note" title="访问github源码">github</a></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"nav":{"name":"wasm","fullPath":"/special/wasm","asPath":"/special/wasm","id":"%2Fspecial%2Fwasm","parent":{"name":"special","fullPath":"/special","asPath":"/special","id":"%2Fspecial","readme":{"title":"专题","fullPath":"/special/README.md"}},"readme":{"title":"WebAssembly","fullPath":"/special/wasm/README.md"},"cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/wasm/go.md"},{"name":"rust.md","baseName":"rust","extName":".md","fullPath":"/special/wasm/rust.md"}],"nodes":[]},"content":"","cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/wasm/go.md","content":"## 构建\n\n```go\n// main.go\npackage main\nimport \"fmt\"\n\nfunc main() {\n\tfmt.Println(\"Hello, WebAssembly!\")\n}\n```\n\n```sh\nGOOS=js GOARCH=wasm go build -o main.wasm .\n```\n\n## 使用\n\n```sh\n# 拷贝必要的js\ncp \"$(go env GOROOT)/misc/wasm/wasm_exec.js\" .\n\n# 安装web工具\ngo get -u github.com/shurcooL/goexec\n\n# 启动web服务\ngoexec 'http.ListenAndServe(`:8080`, http.FileServer(http.Dir(`.`)))'\n```\n\n```html\n\u003c!-- index.html --\u003e\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"utf-8\" /\u003e\n    \u003cscript src=\"wasm_exec.js\"\u003e\u003c/script\u003e\n    \u003cscript\u003e\n      const go = new Go();\n      WebAssembly.instantiateStreaming(\n        fetch(\"main.wasm\"),\n        go.importObject\n      ).then((result) =\u003e {\n        go.run(result.instance);\n      });\n    \u003c/script\u003e\n  \u003c/head\u003e\n  \u003cbody\u003e\u003c/body\u003e\n\u003c/html\u003e\n```\n\n## 更多例子\n\n### 注册函数(Register Functions)\n\n```go\n// main.go\npackage main\n\nimport \"syscall/js\"\n\nfunc fib(i int) int {\n\tif i == 0 || i == 1 {\n\t\treturn i\n\t}\n\treturn fib(i-1) + fib(i-2)\n}\n\nfunc fibFunc(this js.Value, args []js.Value) interface{} {\n\treturn js.ValueOf(fib(args[0].Int()))\n}\n\nfunc main() {\n\tdone := make(chan int)\n\tjs.Global().Set(\"fibFunc\", js.FuncOf(fibFunc))\n\t\u003c-done\n}\n```\n\n```html\n\u003c!-- index.html --\u003e\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"utf-8\" /\u003e\n    \u003cscript src=\"wasm_exec.js\"\u003e\u003c/script\u003e\n    \u003cscript\u003e\n      const go = new Go();\n      WebAssembly.instantiateStreaming(\n        fetch(\"main.wasm\"),\n        go.importObject\n      ).then((result) =\u003e {\n        go.run(result.instance);\n      });\n    \u003c/script\u003e\n  \u003c/head\u003e\n  \u003cbody\u003e\n    \u003cinput id=\"num\" type=\"number\" /\u003e\n    \u003cbutton id=\"btn\" onclick=\"ans.innerHTML=fibFunc(num.value * 1)\"\u003e\n      Click\n    \u003c/button\u003e\n    \u003cp id=\"ans\"\u003e1\u003c/p\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\n### 操作 DOM\n\n```go\n// main.go\npackage main\n\nimport (\n\t\"strconv\"\n\t\"syscall/js\"\n)\n\nfunc fib(i int) int {\n\tif i == 0 || i == 1 {\n\t\treturn i\n\t}\n\treturn fib(i-1) + fib(i-2)\n}\n\nvar (\n\tdocument = js.Global().Get(\"document\")\n\tnumEle   = document.Call(\"getElementById\", \"num\")\n\tansEle   = document.Call(\"getElementById\", \"ans\")\n\tbtnEle   = js.Global().Get(\"btn\")\n)\n\nfunc fibFunc(this js.Value, args []js.Value) interface{} {\n\tv := numEle.Get(\"value\")\n\tif num, err := strconv.Atoi(v.String()); err == nil {\n\t\tansEle.Set(\"innerHTML\", js.ValueOf(fib(num)))\n\t}\n\treturn nil\n}\n\nfunc main() {\n\tdone := make(chan int)\n\tbtnEle.Call(\"addEventListener\", \"click\", js.FuncOf(fibFunc))\n\t\u003c-done\n}\n```\n\n```html\n\u003c!-- index.html --\u003e\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"utf-8\" /\u003e\n    \u003cscript src=\"wasm_exec.js\"\u003e\u003c/script\u003e\n    \u003cscript\u003e\n      const go = new Go();\n      WebAssembly.instantiateStreaming(\n        fetch(\"main.wasm\"),\n        go.importObject\n      ).then((result) =\u003e {\n        go.run(result.instance);\n      });\n    \u003c/script\u003e\n  \u003c/head\u003e\n  \u003cbody\u003e\n    \u003cinput id=\"num\" type=\"number\" /\u003e\n    \u003cbutton id=\"btn\"\u003eClick\u003c/button\u003e\n    \u003cp id=\"ans\"\u003e1\u003c/p\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\n### 回调函数(Callback Functions)\n\n```go\n// main.go\npackage main\n\nimport (\n\t\"syscall/js\"\n\t\"time\"\n)\n\nfunc fib(i int) int {\n\tif i == 0 || i == 1 {\n\t\treturn i\n\t}\n\treturn fib(i-1) + fib(i-2)\n}\n\nfunc fibFunc(this js.Value, args []js.Value) interface{} {\n\tcallback := args[len(args)-1]\n\n    // 异步执行\n\tgo func() {\n\t\ttime.Sleep(3 * time.Second)\n\t\tv := fib(args[0].Int())\n\t\tcallback.Invoke(v) // 执行完成，调用回调函数\n\t}()\n\n\tjs.Global().Get(\"ans\").Set(\"innerHTML\", \"Waiting 3s...\")\n\treturn nil\n}\n\nfunc main() {\n\tdone := make(chan int)\n\tjs.Global().Set(\"fibFunc\", js.FuncOf(fibFunc))\n\t\u003c-done\n}\n```\n\n```html\n\u003c!-- index.html --\u003e\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"utf-8\" /\u003e\n    \u003cscript src=\"wasm_exec.js\"\u003e\u003c/script\u003e\n    \u003cscript\u003e\n      const go = new Go();\n      WebAssembly.instantiateStreaming(\n        fetch(\"main.wasm\"),\n        go.importObject\n      ).then((result) =\u003e {\n        go.run(result.instance);\n      });\n    \u003c/script\u003e\n  \u003c/head\u003e\n  \u003cbody\u003e\n    \u003cinput id=\"num\" type=\"number\" /\u003e\n    \u003cbutton id=\"btn\" onclick=\"fibFunc(num.value * 1, (v)=\u003e ans.innerHTML=v)\"\u003e\n      Click\n    \u003c/button\u003e\n    \u003cp id=\"ans\"\u003e\u003c/p\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\n### Performance - JavaScript vs Go\n\n```go\npackage main\n\nimport \"syscall/js\"\n\nfunc fib(i int) int {\n\tif i == 0 || i == 1 {\n\t\treturn i\n\t}\n\treturn fib(i-1) + fib(i-2)\n}\n\nfunc fibFunc(this js.Value, args []js.Value) interface{} {\n\treturn js.ValueOf(fib(args[0].Int()))\n}\n\nfunc main() {\n\tdone := make(chan int)\n\tjs.Global().Set(\"fibFunc\", js.FuncOf(fibFunc))\n\t\u003c-done\n}\n```\n\n```html\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"utf-8\" /\u003e\n    \u003cscript src=\"./wasm_exec.js\"\u003e\u003c/script\u003e\n    \u003cscript type=\"module\"\u003e\n      function fibonacciInJs(n) {\n        if (n \u003c= 1) return n;\n        return fibonacciInJs(n - 1) + fibonacciInJs(n - 2);\n      }\n\n      async function run() {\n        const go = new Go();\n        const result = await WebAssembly.instantiateStreaming(\n          fetch(\"main.wasm\"),\n          go.importObject\n        );\n        go.run(result.instance);\n\n        const num = 20;\n\n        console.time(\"Fibonnaci in go\");\n        const fibGo = fibFunc(num);\n        console.timeEnd(\"Fibonnaci in go\");\n\n        console.time(\"Fibonnaci in JS\");\n        const fibJS = fibonacciInJs(num);\n        console.timeEnd(\"Fibonnaci in JS\");\n\n        document.body.textContent = `Fib ${num}: Go ${fibGo} - JS ${fibJS}`;\n      }\n\n      run();\n    \u003c/script\u003e\n  \u003c/head\u003e\n  \u003cbody\u003e\u003c/body\u003e\n\u003c/html\u003e\n```\n\n## 优化\n\n```sh\n# 优化前命令\nGOOS=js GOARCH=wasm go build -o ./main.wasm ./main.go\n\n# 利用 tinygo\ntinygo build -o ./main.wasm -target wasm ./main.go\ntinygo build -o ./main.wasm -target wasm -no-debug ./main.go\n```\n"},{"name":"rust.md","baseName":"rust","extName":".md","fullPath":"/special/wasm/rust.md","content":"参考： https://developer.mozilla.org/zh-CN/docs/WebAssembly/Rust_to_wasm\n\n## 环境\n\n### 安装 rust\n\n### wasm-pack\n\n```sh\ncargo install wasm-pack\n```\n\n### 安装 npm\n\n## 构建\n\n```sh\n# 创建一个lib项目\ncargo new --lib hello-wasm\n\n# 修改对应文件\n\n# 构建包\n# --target bundler - for bundlers like Webpack, Parcel, or Rollup.\n# --target web - for the web as ECMAScript module.\n# --target no-modules - for the web without ECMAScript module.\n# --target nodejs - for Node.js\n# wasm-pack build --scope mynpmusername\nwasm-pack build --target bundler\n\n# 发布包（可选）\ncd pkg\nnpm publish --access=public\n```\n\n```rust\n// src/lib.rs\nextern crate wasm_bindgen;\nuse wasm_bindgen::prelude::*;\n\n#[wasm_bindgen]\nextern {\n    pub fn alert(s: \u0026str);\n}\n\n#[wasm_bindgen]\npub fn greet(name: \u0026str) {\n    alert(\u0026format!(\"Hello, {}!\", name));\n}\n```\n\n```toml\n# Cargo.toml\n[package]\nname = \"hello-wasm\"\nversion = \"0.1.0\"\nauthors = [\"Your Name \u003cyou@example.com\u003e\"]\ndescription = \"A sample project with wasm-pack\"\nlicense = \"MIT/Apache-2.0\"\nrepository = \"https://github.com/yourgithubusername/hello-wasm\"\n\n[lib]\ncrate-type = [\"cdylib\"]\n\n[dependencies]\nwasm-bindgen = \"0.2\"\n```\n\n## 使用构建生成的 wasm\n\n### 新建 site 项目\n\n```json\n// package.json\n{\n  \"scripts\": {\n    \"serve\": \"webpack-dev-server\"\n  },\n  //   \"dependencies\": {\n  //     \"@mynpmusername/hello-wasm\": \"^0.1.0\"\n  //   },\n  \"devDependencies\": {\n    \"webpack\": \"^4.25.1\",\n    \"webpack-cli\": \"^3.1.2\",\n    \"webpack-dev-server\": \"^3.1.10\"\n  }\n}\n```\n\n```js\n// webpack.config.js\nconst path = require(\"path\");\nmodule.exports = {\n  entry: \"./index.js\",\n  output: {\n    path: path.resolve(__dirname, \"dist\"),\n    filename: \"index.js\",\n  },\n  mode: \"development\",\n};\n```\n\n```html\n\u003c!-- index.html --\u003e\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"utf-8\" /\u003e\n    \u003ctitle\u003ehello-wasm example\u003c/title\u003e\n  \u003c/head\u003e\n  \u003cbody\u003e\n    \u003cscript src=\"./index.js\"\u003e\u003c/script\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\n```js\n// index.js\nconst js = import(\"../pkg/hello_wasm.js\");\njs.then((js) =\u003e {\n  js.greet(\"WebAssembly\");\n});\n```\n\n### 测试\n\n```sh\nnpm install\nnpm run serve\n```\n\n### 错误\n\n```sh\n  opensslErrorStack: [ 'error:03000086:digital envelope routines::initialization error' ],\n  library: 'digital envelope routines',\n  reason: 'unsupported',\n  code: 'ERR_OSSL_EVP_UNSUPPORTED'\n```\n\n```sh\n#For Windows, use the below command in cmd:\nset NODE_OPTIONS=--openssl-legacy-provider\n#For Unix, use:\nexport NODE_OPTIONS=--openssl-legacy-provider\n```\n\n## 更多例子\n\n参考： https://rustwasm.github.io/wasm-bindgen/examples/index.html\n\n```sh\nwasm-pack build --target web --debug\n\n# npm install --global http-server\n# http-server\nnpx serve .\n```\n\n### Execute Rust code from JavaScript\n\n```rust\n// src/lib.rs\nuse wasm_bindgen::prelude::*;\n\n#[wasm_bindgen]\npub fn helloworld() -\u003e String {\n    String::from(\"Hello world from Rust!\")\n}\n```\n\n```html\n\u003c!-- index.html --\u003e\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"UTF-8\" /\u003e\n    \u003ctitle\u003e\"Hello world\" in Rust + Webassembly\u003c/title\u003e\n    \u003cscript type=\"module\"\u003e\n      import init, { helloworld } from \"./pkg/hello_wasm.js\";\n\n      async function run() {\n        await init();\n        document.body.textContent = helloworld();\n      }\n\n      run();\n    \u003c/script\u003e\n  \u003c/head\u003e\n\n  \u003cbody\u003e\u003c/body\u003e\n\u003c/html\u003e\n```\n\n### Execute JavaScript code from Rust\n\n```rust\n// use the function console.log inside Rust\nuse wasm_bindgen::prelude::*;\n\n#[wasm_bindgen]\nextern \"C\" {\n    #[wasm_bindgen(js_namespace = console)]\n    fn log(s: \u0026str);\n}\n\n#[wasm_bindgen]\npub fn example() {\n    log(\"Log from rust\");\n}\n```\n\n```js\nimport init, { example } from \"./pkg/helloworld.js\";\n\nasync function run() {\n  await init();\n  example(); // This will log \"Log from rust\" to the console\n}\n\nrun();\n```\n\n### Performance - JavaScript vs Rust\n\n```rust\nuse wasm_bindgen::prelude::*;\n\n#[wasm_bindgen]\npub fn fibonacci(n: u32) -\u003e u32 {\n    match n {\n        0 | 1 =\u003e n,\n        _ =\u003e fibonacci(n - 1) + fibonacci(n - 2),\n    }\n}\n```\n\n```js\nimport init, { fibonacci } from \"./pkg/helloworld.js\";\n\nfunction fibonacciInJs(n) {\n  if (n \u003c= 1) return n;\n  return fibonacciInJs(n - 1) + fibonacciInJs(n - 2);\n}\n\nasync function run() {\n  await init();\n  const num = 20;\n\n  console.time(\"Fibonnaci in rust\");\n  const fibRust = fibonacci(num);\n  console.timeEnd(\"Fibonnaci in rust\");\n\n  console.time(\"Fibonnaci in JS\");\n  const fibJS = fibonacciInJs(num);\n  console.timeEnd(\"Fibonnaci in JS\");\n\n  document.body.textContent = `Fib ${num}: Rust ${fibRust} - JS ${fibJS}`;\n}\n\nrun();\n```\n\n### Publishing to NPM\n\n```sh\n# They work the same way as with npm pack and npm publish\nwasm-pack pack myproject/pkg\nwasm-pack publish\n```\n\n### run\n\n```rust\nuse wasm_bindgen::prelude::*;\n\n// Called by our JS entry point to run the example\n#[wasm_bindgen(start)]\npub fn run() -\u003e Result\u003c(), JsValue\u003e {\n    // Use `web_sys`'s global `window` function to get a handle on the global\n    // window object.\n    let window = web_sys::window().expect(\"no global `window` exists\");\n    let document = window.document().expect(\"should have a document on window\");\n    let body = document.body().expect(\"document should have a body\");\n\n    // Manufacture the element we're gonna append\n    let val = document.create_element(\"p\")?;\n    val.set_text_content(Some(\"Hello from Rust!\"));\n\n    body.append_child(\u0026val)?;\n\n    Ok(())\n}\n```\n\n```toml\n[lib]\ncrate-type = [\"cdylib\"]\n\n[dependencies]\nwasm-bindgen = \"0.2\"\n\n[dependencies.web-sys]\nversion = \"0.3.4\"\nfeatures = [\n  'Document',\n  'Element',\n  'HtmlElement',\n  'Node',\n  'Window',\n]\n```\n\n```html\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"UTF-8\" /\u003e\n    \u003ctitle\u003e\"Hello world\" in Rust + Webassembly\u003c/title\u003e\n    \u003cscript type=\"module\"\u003e\n      import init from \"./pkg/helloworld.js\";\n\n      async function run() {\n        await init();\n      }\n\n      run();\n    \u003c/script\u003e\n  \u003c/head\u003e\n\n  \u003cbody\u003e\u003c/body\u003e\n\u003c/html\u003e\n```\n"}]}},"page":"/[...param]","query":{"param":["special","wasm"]},"buildId":"S-jJrz2DKYE9I2Mqo2Xou","assetPrefix":"/comparison-note","nextExport":true,"isFallback":false,"gip":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"WebAssembly"}]]}</script><script nomodule="" src="/comparison-note/_next/static/chunks/polyfills-7258ef49cf482e03ae9c.js"></script><script src="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" async=""></script><script src="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" async=""></script><script src="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" async=""></script><script src="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" async=""></script><script src="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" async=""></script><script src="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_buildManifest.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_ssgManifest.js" async=""></script></body></html>
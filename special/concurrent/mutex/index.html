<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>互斥锁</title><link rel="preload" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" data-n-g=""/><link rel="preload" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" as="script"/></head><body><div id="__next"><nav class="navbar navbar-expand-lg navbar-light bg-light"><a href="/comparison-note/" class="navbar-brand">对比学习笔记</a><button aria-controls="basic-navbar-nav" type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="navbar-collapse collapse" id="basic-navbar-nav"><div class="mr-auto navbar-nav"><a href="/comparison-note/algorithm" data-rb-event-key="/algorithm" class="nav-link">数据结构和算法</a><a href="/comparison-note/basic-concept" data-rb-event-key="/basic-concept" class="nav-link">基础概念</a><a href="/comparison-note/data-type" data-rb-event-key="/data-type" class="nav-link">数据类型</a><a href="/comparison-note/special" data-rb-event-key="/special" class="nav-link">专题</a></div></div></nav><div style="padding-top:12px;padding-bottom:12px" class="container-fluid"><h1>互斥锁</h1><div style="margin-bottom:12px"><div class="markdown-body"></div></div><div style="margin-bottom:12px" class="justify-content-md-center row"><div class="col-md-auto"><div role="toolbar" class="btn-toolbar"><div role="group" class="btn-group btn-group-sm btn-group-toggle"><label class="btn btn-secondary"><input type="checkbox" value="go" autoComplete="off"/>go</label><label class="btn btn-secondary"><input type="checkbox" value="rust" autoComplete="off"/>rust</label></div></div></div></div><div class="card-group"></div></div><div style="text-align:center;padding:12px 0;font-size:14px">v<!-- -->0.1.0<!-- --> <a href="https://github.com/fishjar/comparison-note" title="访问github源码">github</a></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"nav":{"name":"mutex","fullPath":"/special/concurrent/mutex","asPath":"/special/concurrent/mutex","id":"%2Fspecial%2Fconcurrent%2Fmutex","parent":{"name":"concurrent","fullPath":"/special/concurrent","asPath":"/special/concurrent","id":"%2Fspecial%2Fconcurrent","readme":{"title":"并发编程","fullPath":"/special/concurrent/README.md"}},"readme":{"title":"互斥锁","fullPath":"/special/concurrent/mutex/README.md"},"cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/concurrent/mutex/go.md"},{"name":"rust.md","baseName":"rust","extName":".md","fullPath":"/special/concurrent/mutex/rust.md"}],"nodes":[]},"content":"","cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/concurrent/mutex/go.md","content":"- 若我们只是想保证每次只有一个 Go 程能够访问一个共享的变量，从而避免冲突？\n- 我们通常使用 _互斥锁（Mutex）_ 这一数据结构来提供这种机制。\n- 我们可以通过在代码前调用 Lock 方法，在代码后调用 Unlock 方法来保证一段代码的互斥执行。\n- 我们也可以用 defer 语句来保证互斥锁一定会被解锁\n\n```go\npackage main\nimport (\n  \"fmt\"\n  \"sync\"\n  \"time\"\n)\n// SafeCounter 的并发使用是安全的。\ntype SafeCounter struct {\n  v   map[string]int\n  mux sync.Mutex\n}\n// Inc 增加给定 key 的计数器的值。\nfunc (c *SafeCounter) Inc(key string) {\n  c.mux.Lock()\n  // Lock 之后同一时刻只有一个 goroutine 能访问 c.v\n  c.v[key]++\n  c.mux.Unlock()\n}\n// Value 返回给定 key 的计数器的当前值。\nfunc (c *SafeCounter) Value(key string) int {\n  c.mux.Lock()\n  // Lock 之后同一时刻只有一个 goroutine 能访问 c.v\n  defer c.mux.Unlock()\n  return c.v[key]\n}\nfunc main() {\n  c := SafeCounter{v: make(map[string]int)}\n  for i := 0; i \u003c 1000; i++ {\n    go c.Inc(\"somekey\")\n  }\n  time.Sleep(time.Second)\n  fmt.Println(c.Value(\"somekey\"))\n}\n```\n\n```go\npackage main\n\nimport (\n    \"fmt\"\n    \"sync\"\n)\n\ntype Container struct {\n    mu       sync.Mutex\n    counters map[string]int\n}\n\nfunc (c *Container) inc(name string) {\n    c.mu.Lock()\n    defer c.mu.Unlock()\n    c.counters[name]++\n}\n\nfunc main() {\n    c := Container{\n        counters: map[string]int{\"a\": 0, \"b\": 0},\n    }\n\n    var wg sync.WaitGroup\n    doIncrement := func(name string, n int) {\n        for i := 0; i \u003c n; i++ {\n            c.inc(name)\n        }\n        wg.Done()\n    }\n\n    wg.Add(3)\n    go doIncrement(\"a\", 10000)\n    go doIncrement(\"a\", 10000)\n    go doIncrement(\"b\", 10000)\n\n    wg.Wait()\n    fmt.Println(c.counters)\n}\n```\n"},{"name":"rust.md","baseName":"rust","extName":".md","fullPath":"/special/concurrent/mutex/rust.md","content":"互斥器（mutex）是 mutual exclusion 的缩写，也就是说，任意时刻，其只允许一个线程访问某些数据。\n\n```rust\nuse std::sync::Mutex;\nfn main() {\n    // Mutex\u003ci32\u003e 并不是一个 i32，所以 必须 获取锁才能使用这个 i32 值。\n    // Mutex\u003cT\u003e 是一个智能指针。\n    // Mutex\u003cT\u003e 提供了内部可变性，就像 Cell 系列类型那样。\n    let m = Mutex::new(5);\n    {\n        // lock 调用 返回 一个叫做 MutexGuard 的智能指针。\n        // 这个智能指针实现了 Deref 来指向其内部数据；\n        // 其也提供了一个 Drop 实现当 MutexGuard 离开作用域时自动释放锁，\n        let mut num = m.lock().unwrap();\n        *num = 6;\n    }\n    println!(\"m = {:?}\", m);\n}\n```\n\n## 原子引用计数 `Arc\u003cT\u003e`\n\n- 使用 `RefCell\u003cT\u003e` 可以改变 `Rc\u003cT\u003e` 中的内容那样，\n- 同样的可以使用 `Mutex\u003cT\u003e` 来改变 `Arc\u003cT\u003e` 中的内容。\n\n```rust\nuse std::sync::{Mutex, Arc};\nuse std::thread;\n\nfn main() {\n    let counter = Arc::new(Mutex::new(0));\n    let mut handles = vec![];\n\n    for _ in 0..10 {\n        let counter = Arc::clone(\u0026counter);\n        let handle = thread::spawn(move || {\n            let mut num = counter.lock().unwrap();\n\n            *num += 1;\n        });\n        handles.push(handle);\n    }\n\n    for handle in handles {\n        handle.join().unwrap();\n    }\n\n    println!(\"Result: {}\", *counter.lock().unwrap());\n}\n```\n"}]}},"page":"/[...param]","query":{"param":["special","concurrent","mutex"]},"buildId":"S-jJrz2DKYE9I2Mqo2Xou","assetPrefix":"/comparison-note","nextExport":true,"isFallback":false,"gip":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"互斥锁"}]]}</script><script nomodule="" src="/comparison-note/_next/static/chunks/polyfills-7258ef49cf482e03ae9c.js"></script><script src="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" async=""></script><script src="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" async=""></script><script src="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" async=""></script><script src="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" async=""></script><script src="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" async=""></script><script src="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_buildManifest.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_ssgManifest.js" async=""></script></body></html>
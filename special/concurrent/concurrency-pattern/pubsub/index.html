<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>发布订阅模型</title><link rel="preload" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" data-n-g=""/><link rel="preload" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" as="script"/></head><body><div id="__next"><nav class="navbar navbar-expand-lg navbar-light bg-light"><a href="/comparison-note/" class="navbar-brand">对比学习笔记</a><button aria-controls="basic-navbar-nav" type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="navbar-collapse collapse" id="basic-navbar-nav"><div class="mr-auto navbar-nav"><a href="/comparison-note/algorithm" data-rb-event-key="/algorithm" class="nav-link">数据结构和算法</a><a href="/comparison-note/basic-concept" data-rb-event-key="/basic-concept" class="nav-link">基础概念</a><a href="/comparison-note/data-type" data-rb-event-key="/data-type" class="nav-link">数据类型</a><a href="/comparison-note/special" data-rb-event-key="/special" class="nav-link">专题</a></div></div></nav><div style="padding-top:12px;padding-bottom:12px" class="container-fluid"><h1>发布订阅模型</h1><div style="margin-bottom:12px"><div class="markdown-body"></div></div><div style="margin-bottom:12px" class="justify-content-md-center row"><div class="col-md-auto"><div role="toolbar" class="btn-toolbar"><div role="group" class="btn-group btn-group-sm btn-group-toggle"><label class="btn btn-secondary"><input type="checkbox" value="go" autoComplete="off"/>go</label></div></div></div></div><div class="card-group"></div></div><div style="text-align:center;padding:12px 0;font-size:14px">v<!-- -->0.1.0<!-- --> <a href="https://github.com/fishjar/comparison-note" title="访问github源码">github</a></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"nav":{"name":"pubsub","fullPath":"/special/concurrent/concurrency-pattern/pubsub","asPath":"/special/concurrent/concurrency-pattern/pubsub","id":"%2Fspecial%2Fconcurrent%2Fconcurrency-pattern%2Fpubsub","parent":{"name":"concurrency-pattern","fullPath":"/special/concurrent/concurrency-pattern","asPath":"/special/concurrent/concurrency-pattern","id":"%2Fspecial%2Fconcurrent%2Fconcurrency-pattern","readme":{"title":"并发模式","fullPath":"/special/concurrent/concurrency-pattern/README.md"}},"readme":{"title":"发布订阅模型","fullPath":"/special/concurrent/concurrency-pattern/pubsub/README.md"},"cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/concurrent/concurrency-pattern/pubsub/go.md"}],"nodes":[]},"content":"","cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/special/concurrent/concurrency-pattern/pubsub/go.md","content":"```go\n// Package pubsub implements a simple multi-topic pub-sub library.\npackage pubsub\n\nimport (\n    \"sync\"\n    \"time\"\n)\n\ntype (\n    subscriber chan interface{}         // 订阅者为一个管道\n    topicFunc  func(v interface{}) bool // 主题为一个过滤器\n)\n\n// 发布者对象\ntype Publisher struct {\n    m           sync.RWMutex             // 读写锁\n    buffer      int                      // 订阅队列的缓存大小\n    timeout     time.Duration            // 发布超时时间\n    subscribers map[subscriber]topicFunc // 订阅者信息\n}\n\n// 构建一个发布者对象, 可以设置发布超时时间和缓存队列的长度\nfunc NewPublisher(publishTimeout time.Duration, buffer int) *Publisher {\n    return \u0026Publisher{\n        buffer:      buffer,\n        timeout:     publishTimeout,\n        subscribers: make(map[subscriber]topicFunc),\n    }\n}\n\n// 添加一个新的订阅者，订阅全部主题\nfunc (p *Publisher) Subscribe() chan interface{} {\n    return p.SubscribeTopic(nil)\n}\n\n// 添加一个新的订阅者，订阅过滤器筛选后的主题\nfunc (p *Publisher) SubscribeTopic(topic topicFunc) chan interface{} {\n    ch := make(chan interface{}, p.buffer)\n    p.m.Lock()\n    p.subscribers[ch] = topic\n    p.m.Unlock()\n    return ch\n}\n\n// 退出订阅\nfunc (p *Publisher) Evict(sub chan interface{}) {\n    p.m.Lock()\n    defer p.m.Unlock()\n\n    delete(p.subscribers, sub)\n    close(sub)\n}\n\n// 发布一个主题\nfunc (p *Publisher) Publish(v interface{}) {\n    p.m.RLock()\n    defer p.m.RUnlock()\n\n    var wg sync.WaitGroup\n    for sub, topic := range p.subscribers {\n        wg.Add(1)\n        go p.sendTopic(sub, topic, v, \u0026wg)\n    }\n    wg.Wait()\n}\n\n// 关闭发布者对象，同时关闭所有的订阅者管道。\nfunc (p *Publisher) Close() {\n    p.m.Lock()\n    defer p.m.Unlock()\n\n    for sub := range p.subscribers {\n        delete(p.subscribers, sub)\n        close(sub)\n    }\n}\n\n// 发送主题，可以容忍一定的超时\nfunc (p *Publisher) sendTopic(\n    sub subscriber, topic topicFunc, v interface{}, wg *sync.WaitGroup,\n) {\n    defer wg.Done()\n    if topic != nil \u0026\u0026 !topic(v) {\n        return\n    }\n\n    select {\n    case sub \u003c- v:\n    case \u003c-time.After(p.timeout):\n    }\n}\n```\n\n```go\nimport \"path/to/pubsub\"\n\nfunc main() {\n    p := pubsub.NewPublisher(100*time.Millisecond, 10)\n    defer p.Close()\n\n    all := p.Subscribe()\n    golang := p.SubscribeTopic(func(v interface{}) bool {\n        if s, ok := v.(string); ok {\n            return strings.Contains(s, \"golang\")\n        }\n        return false\n    })\n\n    p.Publish(\"hello,  world!\")\n    p.Publish(\"hello, golang!\")\n\n    go func() {\n        for  msg := range all {\n            fmt.Println(\"all:\", msg)\n        }\n    } ()\n\n    go func() {\n        for  msg := range golang {\n            fmt.Println(\"golang:\", msg)\n        }\n    } ()\n\n    // 运行一定时间后退出\n    time.Sleep(3 * time.Second)\n}\n```\n"}]}},"page":"/[...param]","query":{"param":["special","concurrent","concurrency-pattern","pubsub"]},"buildId":"S-jJrz2DKYE9I2Mqo2Xou","assetPrefix":"/comparison-note","nextExport":true,"isFallback":false,"gip":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"发布订阅模型"}]]}</script><script nomodule="" src="/comparison-note/_next/static/chunks/polyfills-7258ef49cf482e03ae9c.js"></script><script src="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" async=""></script><script src="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" async=""></script><script src="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" async=""></script><script src="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" async=""></script><script src="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" async=""></script><script src="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_buildManifest.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_ssgManifest.js" async=""></script></body></html>
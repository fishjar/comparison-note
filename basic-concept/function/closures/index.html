<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>闭包</title><link rel="preload" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" data-n-g=""/><link rel="preload" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" as="script"/></head><body><div id="__next"><nav class="navbar navbar-expand-lg navbar-light bg-light"><a href="/comparison-note/" class="navbar-brand">对比学习笔记</a><button aria-controls="basic-navbar-nav" type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="navbar-collapse collapse" id="basic-navbar-nav"><div class="mr-auto navbar-nav"><a href="/comparison-note/algorithm" data-rb-event-key="/algorithm" class="nav-link">数据结构和算法</a><a href="/comparison-note/basic-concept" data-rb-event-key="/basic-concept" class="nav-link">基础概念</a><a href="/comparison-note/data-type" data-rb-event-key="/data-type" class="nav-link">数据类型</a><a href="/comparison-note/special" data-rb-event-key="/special" class="nav-link">专题</a></div></div></nav><div style="padding-top:12px;padding-bottom:12px" class="container-fluid"><h1>闭包</h1><div style="margin-bottom:12px"><div class="markdown-body"></div></div><div style="margin-bottom:12px" class="justify-content-md-center row"><div class="col-md-auto"><div role="toolbar" class="btn-toolbar"><div role="group" class="btn-group btn-group-sm btn-group-toggle"><label class="btn btn-secondary"><input type="checkbox" value="go" autoComplete="off"/>go</label><label class="btn btn-secondary"><input type="checkbox" value="rust" autoComplete="off"/>rust</label></div></div></div></div><div class="card-group"></div></div><div style="text-align:center;padding:12px 0;font-size:14px">v<!-- -->0.1.0<!-- --> <a href="https://github.com/fishjar/comparison-note" title="访问github源码">github</a></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"nav":{"name":"closures","fullPath":"/basic-concept/function/closures","asPath":"/basic-concept/function/closures","id":"%2Fbasic-concept%2Ffunction%2Fclosures","parent":{"name":"function","fullPath":"/basic-concept/function","asPath":"/basic-concept/function","id":"%2Fbasic-concept%2Ffunction","readme":{"title":"函数和方法","fullPath":"/basic-concept/function/README.md"}},"readme":{"title":"闭包","fullPath":"/basic-concept/function/closures/README.md"},"cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/basic-concept/function/closures/go.md"},{"name":"rust.md","baseName":"rust","extName":".md","fullPath":"/basic-concept/function/closures/rust.md"}],"nodes":[]},"content":"","cards":[{"name":"go.md","baseName":"go","extName":".md","fullPath":"/basic-concept/function/closures/go.md","content":"```go\npackage main\n\nimport \"fmt\"\n\nfunc intSeq() func() int {\n    i := 0\n    return func() int {\n        i++\n        return i\n    }\n}\n\nfunc main() {\n\n    nextInt := intSeq()\n\n    fmt.Println(nextInt()) // 1\n    fmt.Println(nextInt()) // 2\n    fmt.Println(nextInt()) // 3\n\n    newInts := intSeq()\n    fmt.Println(newInts()) // 1\n}\n```\n"},{"name":"rust.md","baseName":"rust","extName":".md","fullPath":"/basic-concept/function/closures/rust.md","content":"Rust 的 闭包（closures）是可以保存进变量或作为参数传递给其他函数的匿名函数。\n\n```rust\nfn  add_one_v1   (x: u32) -\u003e u32 { x + 1 }\nlet add_one_v2 = |x: u32| -\u003e u32 { x + 1 };\nlet add_one_v3 = |x|             { x + 1 };\nlet add_one_v4 = |x|               x + 1  ;\n```\n\n## 使用带有泛型和 Fn trait 的闭包\n\n```rust\nuse std::thread;\nuse std::time::Duration;\n\nstruct Cacher\u003cT\u003e\n    where T: Fn(u32) -\u003e u32\n{\n    calculation: T,\n    value: Option\u003cu32\u003e,\n}\n\nimpl\u003cT\u003e Cacher\u003cT\u003e\n    where T: Fn(u32) -\u003e u32\n{\n    fn new(calculation: T) -\u003e Cacher\u003cT\u003e {\n        Cacher {\n            calculation,\n            value: None,\n        }\n    }\n\n    fn value(\u0026mut self, arg: u32) -\u003e u32 {\n        match self.value {\n            Some(v) =\u003e v,\n            None =\u003e {\n                let v = (self.calculation)(arg);\n                self.value = Some(v);\n                v\n            },\n        }\n    }\n}\n\nfn generate_workout(intensity: u32, random_number: u32) {\n    let mut expensive_result = Cacher::new(|num| {\n        println!(\"calculating slowly...\");\n        thread::sleep(Duration::from_secs(2));\n        num\n    });\n\n    if intensity \u003c 25 {\n        println!(\n            \"Today, do {} pushups!\",\n            expensive_result.value(intensity)\n        );\n        println!(\n            \"Next, do {} situps!\",\n            expensive_result.value(intensity)\n        );\n    } else {\n        if random_number == 3 {\n            println!(\"Take a break today! Remember to stay hydrated!\");\n        } else {\n            println!(\n                \"Today, run for {} minutes!\",\n                expensive_result.value(intensity)\n            );\n        }\n    }\n}\n```\n\n## 闭包会捕获其环境\n\n```rust\nfn main() {\n    let x = 4;\n    let equal_to_x = |z| z == x;\n    let y = 4;\n    assert!(equal_to_x(y));\n}\n\n// 函数则会错误\nfn main() {\n    let x = 4;\n    fn equal_to_x(z: i32) -\u003e bool { z == x } // 这里x不能使用\n    let y = 4;\n    assert!(equal_to_x(y));\n}\n```\n\n## 函数指针\n\n- `fn` 被称为 函数指针（function pointer）\n- 函数指针实现了所有三个闭包 trait（`Fn`、`FnMut` 和 `FnOnce`）\n  - 所以总是可以在调用期望闭包的函数时传递函数指针作为参数\n  - 这样它就能接受函数或闭包作为参数\n\n```rust\nfn add_one(x: i32) -\u003e i32 {\n    x + 1\n}\n// 使用 fn 类型接受函数指针作为参数\nfn do_twice(f: fn(i32) -\u003e i32, arg: i32) -\u003e i32 {\n    f(arg) + f(arg)\n}\nfn main() {\n    let answer = do_twice(add_one, 5);\n    println!(\"The answer is: {}\", answer);\n}\n\n// 使用闭包\nlet list_of_numbers = vec![1, 2, 3];\nlet list_of_strings: Vec\u003cString\u003e = list_of_numbers\n    .iter()\n    .map(|i| i.to_string())\n    .collect();\n\n// 可以将函数作为 map 的参数来代替闭包\nlet list_of_numbers = vec![1, 2, 3];\nlet list_of_strings: Vec\u003cString\u003e = list_of_numbers\n    .iter()\n    .map(ToString::to_string) // 完全限定语法，因为存在多个叫做 to_string 的函数\n    .collect();\n```\n\n```rust\n// 这里创建了 Status::Value 实例，\n// 它通过 map 用范围的每一个 u32 值调用 Status::Value 的初始化函数\nenum Status {\n    Value(u32),\n    Stop,\n}\nlet list_of_statuses: Vec\u003cStatus\u003e =\n    (0u32..20)\n    .map(Status::Value) // 这些项使用 () 作为初始化语法，这看起来就像函数调用\n    .collect();\n```\n\n## 返回闭包\n\n```rust\n// 错误\n// Rust 并不知道需要多少空间来储存闭包\nfn returns_closure() -\u003e Fn(i32) -\u003e i32 {\n    |x| x + 1\n}\n\n// 修正\nfn returns_closure() -\u003e Box\u003cdyn Fn(i32) -\u003e i32\u003e {\n    Box::new(|x| x + 1)\n}\n```\n"}]}},"page":"/[...param]","query":{"param":["basic-concept","function","closures"]},"buildId":"S-jJrz2DKYE9I2Mqo2Xou","assetPrefix":"/comparison-note","nextExport":true,"isFallback":false,"gip":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"闭包"}]]}</script><script nomodule="" src="/comparison-note/_next/static/chunks/polyfills-7258ef49cf482e03ae9c.js"></script><script src="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" async=""></script><script src="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" async=""></script><script src="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" async=""></script><script src="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" async=""></script><script src="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" async=""></script><script src="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_buildManifest.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_ssgManifest.js" async=""></script></body></html>
<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>条件编译</title><link rel="preload" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/dc4eece8d63e31b4b040.css" data-n-g=""/><link rel="preload" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" as="style"/><link rel="stylesheet" href="/comparison-note/_next/static/css/05437c60348a21355b6c.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" as="script"/><link rel="preload" href="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" as="script"/></head><body><div id="__next"><nav class="navbar navbar-expand-lg navbar-light bg-light"><a href="/comparison-note/" class="navbar-brand">对比学习笔记</a><button aria-controls="basic-navbar-nav" type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="navbar-collapse collapse" id="basic-navbar-nav"><div class="mr-auto navbar-nav"><a href="/comparison-note/algorithm" data-rb-event-key="/algorithm" class="nav-link">数据结构和算法</a><a href="/comparison-note/basic-concept" data-rb-event-key="/basic-concept" class="nav-link">基础概念</a><a href="/comparison-note/data-type" data-rb-event-key="/data-type" class="nav-link">数据类型</a><a href="/comparison-note/special" data-rb-event-key="/special" class="nav-link">专题</a></div></div></nav><div style="padding-top:12px;padding-bottom:12px" class="container-fluid"><h1>条件编译</h1><div style="margin-bottom:12px"><div class="markdown-body"></div></div><div style="margin-bottom:12px" class="justify-content-md-center row"><div class="col-md-auto"><div role="toolbar" class="btn-toolbar"><div role="group" class="btn-group btn-group-sm btn-group-toggle"><label class="btn btn-secondary"><input type="checkbox" value="c" autoComplete="off"/>c</label><label class="btn btn-secondary"><input type="checkbox" value="go" autoComplete="off"/>go</label><label class="btn btn-secondary"><input type="checkbox" value="rust" autoComplete="off"/>rust</label></div></div></div></div><div class="card-group"></div></div><div style="text-align:center;padding:12px 0;font-size:14px">v<!-- -->0.1.0<!-- --> <a href="https://github.com/fishjar/comparison-note" title="访问github源码">github</a></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"nav":{"name":"feature","fullPath":"/basic-concept/compile/feature","asPath":"/basic-concept/compile/feature","id":"%2Fbasic-concept%2Fcompile%2Ffeature","parent":{"name":"compile","fullPath":"/basic-concept/compile","asPath":"/basic-concept/compile","id":"%2Fbasic-concept%2Fcompile","readme":{"title":"编译","fullPath":"/basic-concept/compile/README.md"}},"readme":{"title":"条件编译","fullPath":"/basic-concept/compile/feature/README.md"},"cards":[{"name":"c.md","baseName":"c","extName":".md","fullPath":"/basic-concept/compile/feature/c.md"},{"name":"go.md","baseName":"go","extName":".md","fullPath":"/basic-concept/compile/feature/go.md"},{"name":"rust.md","baseName":"rust","extName":".md","fullPath":"/basic-concept/compile/feature/rust.md"}],"nodes":[]},"content":"","cards":[{"name":"c.md","baseName":"c","extName":".md","fullPath":"/basic-concept/compile/feature/c.md","content":"```c++\n#if 0\n  const double pi = 3.1415; // 不会执行\n#endif\n```\n\n```c++\n#define FOO 1\n\n#if FOO\n  printf(\"defined\\n\");\n#else\n  printf(\"not defined\\n\");\n#endif\n\n\n#if HAPPY_FACTOR == 0\n  printf(\"I'm not happy!\\n\");\n#elif HAPPY_FACTOR == 1\n  printf(\"I'm just regular\\n\");\n#else\n  printf(\"I'm extra happy!\\n\");\n#endif\n```\n\n```c++\n#define DEBUG 1\n#if DEBUG\nprintf(\"value of i : %d\\n\", i);\nprintf(\"value of j : %d\\n\", j);\n#endif\n```\n\n```sh\n# -D参数指定宏DEBUG为1，相当于在代码中指定#define DEBUG 1\ngcc -DDEBUG=1 foo.c\n```\n\n```c++\n// 使用#ifdef...#endif检查这个宏是否定义过\n#ifdef EXTRA_HAPPY\n  printf(\"I'm extra happy!\\n\");\n#else\n  printf(\"I'm just regular\\n\");\n#endif\n\n// 条件加载\n#ifdef MAVIS\n  #include \"foo.h\"\n  #define STABLES 1\n#else\n  #include \"bar.h\"\n  #define STABLES 2\n#endif\n\n\n#ifdef FOO\n// 等同于\n#if defined FOO\n\n\n#if defined IBMPC\n  #include \"ibmpc.h\"\n#elif defined MAC\n  #include \"mac.h\"\n#else\n  #include \"general.h\"\n#endif\n\n\n#ifndef MYHEADER_H\n  #define MYHEADER_H\n  #include \"myheader.h\"\n#endif\n```"},{"name":"go.md","baseName":"go","extName":".md","fullPath":"/basic-concept/compile/feature/go.md","content":"`debug.go`\n\n```go\n// +build debug\npackage main\nconst debug = true\n```\n\n`release.go`\n\n```go\n// +build !debug\npackage main\nconst debug = false\n```\n\n`main.go`\n\n```go\npackage main\nimport \"log\"\nfunc main() {\n\tif debug {\n\t\tlog.Println(\"debug mode is enabled\")\n\t}\n}\n```\n\n- `// +build debug` 表示 `build tags` 中包含 `debug` 时，该源文件参与编译。\n- `// +build !debug` 表示 `build tags` 中不包含 `debug` 时，该源文件参与编译。\n\n例如下面的写法表示：此源文件只能在 `linux/386` 或者 `darwin/386` 平台下编译。\n\n```go\n// +build linux darwin\n// +build 386\n```\n\n```sh\n# 编译一个 debug 版本\ngo build -tags debug -o debug .\n# 编译 release 版本\ngo build -o release .\n```\n"},{"name":"rust.md","baseName":"rust","extName":".md","fullPath":"/basic-concept/compile/feature/rust.md","content":"## 项目可以定义 feature\n\n- 在 Cargo.toml 中定义的 feature 会被 Cargo 通过命令行参数 --cfg 传给 rustc，\n  - 最终由后者完成编译：rustc --cfg ...\n- 例如 ICO 图片格式包含 BMP 和 PNG 格式，\n  - 因此当 ico 被启用后，它还得确保启用 bmp 和 png\n  - 可以理解为： bmp 和 png 是开启 ico 的先决条件\n- 默认情况下，所有的 feature 都会被自动禁用，可以通过 default 来启用它们\n\n```toml\n[features]\ndefault = [\"ico\", \"webp\"]\nbmp = []\npng = []\nico = [\"bmp\", \"png\"]\nwebp = []\n```\n\n```rust\n// 只有在 webp feature 被定义后，以下的 webp 模块才能被引入进来\n#[cfg(feature = \"webp\")]\npub mod webp;\n```\n\n## 可选依赖\n\n- 当依赖被标记为 \"可选 optional\" 时，意味着它默认不会被编译。\n- 这种可选依赖的写法会自动定义一个与依赖同名的 feature，也就是 gif feature，\n  - 这样一来，当我们启用 gif feature 时，该依赖库也会被自动引入并启用：\n  - 例如通过 --feature gif 的方式启用 feature 。\n\n```toml\n[dependencies]\ngif = { version = \"0.11.1\", optional = true }\n```\n\n- 还可以通过显式定义 feature 的方式来启用这些可选依赖库，\n  - avif feature 一旦被启用，那这两个依赖库也将自动被引入\n\n```toml\n[dependencies]\nravif = { version = \"0.6.3\", optional = true }\nrgb = { version = \"0.8.25\", optional = true }\n\n[features]\navif = [\"ravif\", \"rgb\"]\n```\n\n## 依赖库自身的 feature\n\n```toml\n[dependencies]\nserde = { version = \"1.0.118\", features = [\"derive\"] }\n```\n\n以上配置为 `serde` 依赖开启了 `derive` feature，还可以通过 `default-features = false` 来禁用依赖库的 `default` feature :\n\n```toml\n# 这里我们禁用了 flate2 的 default feature，但又手动为它启用了 zlib feature。\n[dependencies]\nflate2 = { version = \"1.0.3\", default-features = false, features = [\"zlib\"] }\n```\n\n### 间接开启依赖库的 feature :\n\n```toml\n[dependencies]\njpeg-decoder = { version = \"0.1.20\", default-features = false }\n\n[features]\n# 我们定义了一个 parallel feature，同时为其启用了 jpeg-decoder 依赖的 rayon feature\n# Enables parallel processing support by enabling the \"rayon\" feature of jpeg-decoder.\nparallel = [\"jpeg-decoder/rayon\"]\n```\n\n## 通过命令行参数启用 feature\n\n- `--features FEATURES`: 启用给出的 feature 列表，可以使用逗号或空格进行分隔，\n  - 若你是在终端中使用，还需要加上双引号，例如 `--features \"foo bar\"`。\n  - 若在工作空间中构建多个 `package`，可以使用 `package-name/feature-name` 为特定的成员启用 features\n- `--all-features`: 启用命令行上所选择的所有包的所有 features\n- `--no-default-features`: 对选择的包禁用 default feature\n\n## 检视已解析的 features\n\n```sh\ncargo tree -e features\ntest_cargo v0.1.0 (/Users/sunfei/development/rust/demos/test_cargo)\n└── uuid feature \"default\"\n    ├── uuid v0.8.2\n    └── uuid feature \"std\"\n        └── uuid v0.8.2\n\n# cargo tree -f \"{p} {f}\" 命令会提供一个更加紧凑的视图：\ncargo tree -f \"{p} {f}\"\ntest_cargo v0.1.0 (/Users/sunfei/development/rust/demos/test_cargo)\n└── uuid v0.8.2 default,std\n```\n"}]}},"page":"/[...param]","query":{"param":["basic-concept","compile","feature"]},"buildId":"S-jJrz2DKYE9I2Mqo2Xou","assetPrefix":"/comparison-note","nextExport":true,"isFallback":false,"gip":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"条件编译"}]]}</script><script nomodule="" src="/comparison-note/_next/static/chunks/polyfills-7258ef49cf482e03ae9c.js"></script><script src="/comparison-note/_next/static/chunks/main-14614ae8e939b9e5961e.js" async=""></script><script src="/comparison-note/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/comparison-note/_next/static/chunks/framework.c7b20b4e446c7cca89e7.js" async=""></script><script src="/comparison-note/_next/static/chunks/7945cc82.ff5578978733a40a67a3.js" async=""></script><script src="/comparison-note/_next/static/chunks/commons.a32a113e095d8f0b1079.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/_app-1832d2b05f1f19d6a06d.js" async=""></script><script src="/comparison-note/_next/static/chunks/a1bc03cf.64f9f8493143216945e6.js" async=""></script><script src="/comparison-note/_next/static/chunks/4d6c67b811e74d3ca6630b1db854b02fef4ff3ce.8a4303f940dd12850a8f.js" async=""></script><script src="/comparison-note/_next/static/chunks/pages/%5B...param%5D-ec17b069b047a5ce78c3.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_buildManifest.js" async=""></script><script src="/comparison-note/_next/static/S-jJrz2DKYE9I2Mqo2Xou/_ssgManifest.js" async=""></script></body></html>